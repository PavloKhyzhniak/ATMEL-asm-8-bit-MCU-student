;**************************************
; работа с клавиатурой
; реализуем динамический опрос клавиатуры
;
work_KeyBoard:
;-------------------------- Инициализация Порта ввода/вывода B

		ldi		r16, 0xFF	; Записываем число $FF в регистр r16
		out		DDRB, r16	; Записываем это число в DDRB
		ldi		r16, 0xF0	; Записываем число $F0 в регистр r16
		out		PORTB, r16	; Записываем то  же число в PORTB
; проинициализировали порт B на вывод 

;-------------------------- Инициализация Порта ввода/вывода D

		ldi		r16, 0x07	; Записываем число $07 в регистр r16
		out		DDRD, r16	; Записываем это число в DDRD
		ldi		r16, 0x00	; Записываем число $F0 в регистр r16
		out		PORTD, r16	; Записываем то  же число в PORTD
; проинициализировали порт D на вывод 0..2 и на ввод 3..7 
Start_Key:
; зажгем линии клавиатуры
	in	tmp1,PORTD 
	ori	tmp1,0x07
	out PORTD,tmp1
;считаем, нажата ли хоть одна клавиша
	in tmp1,PIND
	andi tmp1,0b01111000
	breq Start_Key; ждем нажатия кнопки
; для борьбы с дребезгом 
; будем считывать кнопки пока не считаем 16 раз одну и ту же комбинацию
	clr tmp2
	ldi cnt1,16
Line1:	
; смотрим линию 1 цифры 1 4 7 *
	ldi tmp3,0
	cbi PORTD,PD1
	cbi PORTD,PD2
; если нашли на линии 1 кнопку идем ее определять
	in tmp1,PIND
	andi tmp1,0b01111000
	breq Line2
	rjmp find_key
Line2:
; смотрим линию 2 цифры 2 5 8 0
	ldi tmp3,1
	cbi PORTD,PD0
	sbi PORTD,PD1
; если нашли на линии 2 кнопку идем ее определять
	in tmp1,PIND
	andi tmp1,0b01111000
	breq Line3
	rjmp find_key
Line3:
; смотрим линию 3 цифры 3 6 9 №
	ldi tmp3,2
	cbi PORTD,PD1
	sbi PORTD,PD2
; если нашли на линии 3 кнопку идем ее определять
	in tmp1,PIND
	andi tmp1,0b01111000
	breq Start_Key

find_key:
; идея такая что проверяя все линии
; находим их вес
; если вес в текущем и предыдущем цикле опроса 
; совпадает, то это та кнопка что нужна
; в противном случае у нас дребезг
;
; приоритет у самой последней линии 
; при нажатии нескольких кнопок
; определим ту что ниже находится
	mov tmp2,tmp1

	sbic PIND,PD3
	ldi tmp1,1
	sbic PIND,PD4
	ldi tmp1,4
	sbic PIND,PD5
	ldi tmp1,7
	sbic PIND,PD6
	ldi tmp1,10
	
	cp tmp2,tmp1
	brne find_key

	dec cnt1
	brne find_key

; суммируем состовляющие кода нашей кнопки
	add tmp2,tmp3
; преобразуем регистр для вывода
	ldi tmp3,0xF0
	eor tmp2,tmp3

	out PORTB, tmp2

	rjmp Start_Key
;**************************************

